name: Deploy Documentation
on:
  # workflow_dispatch:  # permite execu칞칚o manual
  # push:
  #   branches: [main]
  #   paths:
  #     - 'src/**'
  #     - '.docs/**'
  #     - 'typedoc.json'
  workflow_run:
    workflows: ["Test"]
    branches: [main]
    types: [completed]


jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write  # Permiss칚o ESSENCIAL
      pages: write     # Novo tipo de permiss칚o para GitHub Pages
      id-token: write  # Necess치rio para OIDC

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build docs
        run:
          npm run docs

      - name: Run tests with coverage
        run: |
          npx vitest run --coverage --outputFile=coverage/coverage-summary.json
          # Garante que a pasta de relat칩rio existe
          mkdir -p coverage/lcov-report

      - name: Generate Coverage Badge
        if: success() && github.ref == 'refs/heads/main'  # S칩 executa se os testes passarem na branch main
        run: |
          # Extrai a cobertura do relat칩rio HTML
          # COVERAGE=$(grep -E "All files.+[0-9.]+%" coverage/lcov-report/index.html | awk '{print $NF}' || echo "unknown")
          COVERAGE=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
          echo "{\"coverage\":\"$COVERAGE\"}" > coverage-badge.json
          echo "九덢잺 Coverage: $COVERAGE"

      - name: Copy coverage badge to docs
        run: |
          cp coverage/coverage-badge.json .docs/.vitepress/dist/


      # - name: Copy additional files
      #   run: |
      #     mkdir -p .docs/.vitepress/typedoc/docs/
      #     cp LICENSE .docs/.vitepress/typedoc
      #     cp ./docs/*.md .docs/.vitepress/typedoc/docs/

      - name: Debug Files
        run: ls -R .docs/.vitepress/dist

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .docs/.vitepress/dist
          destination_dir: ./
          keep_files: false
          force_orphan: true  # Importante para evitar conflitos
          # cname: seu-dominio.com  # Opcional se usar dom칤nio customizado


      - name: Show Documentation URL
        run: |
          echo "游닄 Documentation deployed to:"
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "Custom domain? Check Settings > Pages"
