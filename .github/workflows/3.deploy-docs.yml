name: Deploy Documentation
on:
  # workflow_dispatch:  # permite execuÃ§Ã£o manual
  # push:
  #   branches: [main]
  #   paths:
  #     - 'src/**'
  #     - '.docs/**'
  #     - 'typedoc.json'
  workflow_run:
    workflows: ["Release"]
    branches: [main]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write  # PermissÃ£o ESSENCIAL
      pages: write     # Novo tipo de permissÃ£o para GitHub Pages
      id-token: write  # NecessÃ¡rio para OIDC

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci


      - name: Build docs
        run:
          npm run docs


      - name: Download coverage badge artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage

      - name: Copy coverage badge to docs
        run: |
          cp coverage/coverage-badge.json .docs/.vitepress/dist/


      # - name: Copy additional files
      #   run: |
      #     mkdir -p .docs/.vitepress/typedoc/docs/
      #     cp LICENSE .docs/.vitepress/typedoc
      #     cp ./docs/*.md .docs/.vitepress/typedoc/docs/

      - name: Debug Files
        run: ls -R .docs/.vitepress/dist

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .docs/.vitepress/dist
          destination_dir: ./
          keep_files: false
          force_orphan: true  # Importante para evitar conflitos
          # cname: seu-dominio.com  # Opcional se usar domÃ­nio customizado


      - name: Show Documentation URL
        run: |
          echo "ğŸ“š Documentation deployed to:"
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "Custom domain? Check Settings > Pages"
